# Google Cloud & Blogger API セットアップガイド

⚠️ **このセットアップはオプションです** - まず [QUICKSTART.md](QUICKSTART.md) で動作確認を完了してから、Google Cloud設定に進むことをお勧めします。

## 概要

このドキュメントは、HTMLtoBloggerを使用するために必要なGoogle CloudプロジェクトとBlogger API v3の設定手順を説明します。

## 前提条件

- Googleアカウント（@gmail.com）
- 投稿対象のBloggerブログ（投稿権限があること）
- インターネット接続

## ステップ1: Google Cloudプロジェクトの作成

### 1.1 Google Cloud Consoleにアクセス

```
https://console.cloud.google.com
```

ブラウザで上記URLにアクセスし、Googleアカウントでログインします。

### 1.2 新しいプロジェクトを作成

1. ページ上部の「プロジェクト選択」をクリック
2. 「新しいプロジェクト」ボタンをクリック
3. 以下を入力：
   - **プロジェクト名**: `HTMLtoBlogger` （任意の名前）
   - **組織**: デフォルトのまま
4. 「作成」をクリック

### 1.3 プロジェクトを選択

作成が完了すると、自動的に新しいプロジェクトに切り替わります。

## ステップ2: Blogger API v3を有効化

### 2.1 APIライブラリを開く

左側のナビゲーションメニューから：
```
APIとサービス → ライブラリ
```

### 2.2 Blogger APIを検索・有効化

1. 検索ボックスに「Blogger API」と入力
2. 検索結果から「Blogger API v3」を選択
3. 「有効にする」ボタンをクリック
4. 有効化が完了するまで待機（数秒）

## ステップ3: OAuth 2.0認証情報を設定

### 3.1 OAuth同意画面を設定

1. 左側メニューから：
   ```
   APIとサービス → OAuth同意画面
   ```

2. **User Type**として「外部」を選択
3. 「作成」をクリック

### 3.2 OAuth同意画面の詳細を入力

**必須フィールド:**

| フィールド | 入力内容 | 例 |
|-----------|--------|-----|
| **アプリ名** | アプリケーションの名前 | `HTMLtoBlogger` |
| **ユーザーサポートメール** | サポート用メールアドレス | `your-email@gmail.com` |
| **デベロッパー連絡先情報** | あなたのメールアドレス | `your-email@gmail.com` |

4. 「保存して続行」をクリック

### 3.3 スコープを設定（オプション）

- デフォルトのまま「保存して続行」をクリック
- 次のページでも「保存して続行」をクリック

### 3.4 テストユーザーを追加

1. 「テストユーザー」セクションで「+ ユーザーを追加」をクリック
2. 自分のGoogleメールアドレスを入力
3. 「追加」をクリック
4. 「保存して続行」をクリック

## ステップ4: デスクトップアプリの認証情報を作成

### 4.1 認証情報ページへ移動

```
APIとサービス → 認証情報
```

### 4.2 OAuth クライアントIDを作成

1. 「+ 認証情報を作成」をクリック
2. ドロップダウンから「OAuth クライアント ID」を選択
3. 以下を設定：
   - **アプリケーションの種類**: 「デスクトップアプリ」を選択
   - **名前**: `HTMLtoBlogger Desktop` （任意）
4. 「作成」をクリック

### 4.3 認証情報をダウンロード

1. 作成完了後、ダウンロードボタン（↓アイコン）をクリック
2. JSONファイルが自動ダウンロードされます
3. ファイル名を `credentials.json` に変更
4. プロジェクトルート（`html_tobrogger.py`と同じフォルダ）に配置

```
htmltobrogger/
├─ html-tobrogger.py
├─ data ┬ credentials.json  ← ここに配置
│　　　　├backup
│　　　　├histroy
│　　　　├log
│　　　　├logs
│　　　　├media_man
│　　　　├report
│　　　　├serialization
│　　　　├upload
│　　　　└work
├── find_keywords.py
├── ...
```

## ステップ5: Bloggerブログの情報を取得

### 5.1 ブログIDの確認

1. [Bloggerダッシュボード](https://www.blogger.com) にアクセス
2. 対象のブログを選択
3. ブラウザのURL欄を確認：
   ```
   https://www.blogger.com/blog/posts/{BLOG_ID}
   ```
   `{BLOG_ID}` の数字をメモしておきます

### 5.2 ブログIDを設定
初回起動時に設定ウィザードが表示されるため、手動設定は必須ではありません。
手動で設定する場合は、`config.json5`の`[OPEN_BLOGGER]`セクションを編集します：

```ini
[OPEN_BLOGGER]
ENABLED = true
BLOG_ID = 1234567890123456789
```

## ステップ6: 初回認証フロー

### 6.1 アプリケーションを起動

```bash
python html_tobrogger.py
```

### 6.2 初回認証

1. アップロード処理を試行すると、ブラウザが自動で開きます
2. Googleアカウントの選択画面が表示されます
3. 「HTMLtoBlogger」アプリへのアクセスを許可するよう求められます
4. 「許可」をクリック

### 6.3 トークンの自動保存

1. 初回認証が完了すると、`token.pickle`が自動生成されます
2. このファイルには認証トークンが保存されます
3. 次回以降は自動的に認証情報が使用されます

⚠️ **注意**: `token.pickle`は秘密ファイルです。GitHubなどに公開しないでください。`.gitignore`で除外されています。

## ステップ7: トークンのリフレッシュ

認証トークンは一定期間後に期限切れになります。その場合：

1. 次のアップロード時に自動的にリフレッシュされます
2. 再度ブラウザで認証するよう求められる場合があります
3. 上記ステップ6.2-6.3を繰り返してください

## トラブルシューティング

### Q: 「No module named google」エラーが出る

A: 依存パッケージをインストールしてください：
```bash
pip install -r requirements.txt
```

### Q: 「403 Permission Denied」エラー

A: 以下を確認：
1. `credentials.json`がプロジェクトルートに配置されているか
2. Google CloudでBlogger API v3が有効化されているか
3. テストユーザーに自分のメールアドレスが追加されているか

### Q: token.pickle が生成されない

A: 以下を確認：
1. `credentials.json`の形式が正しいか
2. インターネット接続が確立されているか
3. Google Cloudのクォータ制限に達していないか

### Q: ブラウザが自動で開かない

A: 以下を試してください：
1. ターミナル出力のURLをコピーして手動で開く
2. システムのブラウザ設定を確認
3. Windows Subsystem for Linux (WSL)の場合は、`xdg-open`の設定を確認

## セキュリティに関する注意

⚠️ **絶対にしてはいけないこと:**
- ❌ GitHubなどのパブリックリポジトリに`credentials.json`をコミット
- ❌ 他人に`credentials.json`や`token.pickle`を共有
- ❌ これらのファイルをメールで送信

✅ **推奨事項:**
- `.gitignore`にこれらのファイルが含まれていることを確認
- 定期的に不要な認証情報を削除（Google Cloud Consoleから）
- 複数のGoogle Cloudプロジェクトを使用する場合は、それぞれ分離してください

## API割り当て（Quotas / クォータ）

Google Blogger APIには**2種類のリクエスト制限**があります：

### 📏 1. Daily Limit（1日の総量）

- **ユーザー単位**: 1日あたり1,000,000ユーザー呼び出し
- **プロジェクト単位**: 1日あたり2,000,000ユーザー呼び出し
- **リセット時刻**: 太平洋時間（PT）午前0時（日本時間 16:00-17:00頃）
- **API使用時の投稿**: 1日あたり45件（2026/02/18実測）

### ⚡ 2. Rate Limit（バースト・レート）

- **QPS（Queries Per Second）**: 1秒あたり約1リクエストまで
- **100秒単位**: 1,000リクエストまで
- **カウント方式**: スライディングウィンドウ（短時間に集中したリクエストを監視）

⚠️ **アカウントロックの原因**:
- Daily Limitより**Rate Limitの方が厳しい**です
- 短時間に大量のリクエストを送ると、1日の上限に達していなくても「異常検知」としてアカウントが一時停止される可能性があります

✅ **本ツールの安全設計**:
- デフォルト設定: **11.1秒間隔**（約0.091 QPS）
- 1回の実行: **最大40件**
- Blogger API標準のRate Limit（1 QPS）に準拠

### Quotas確認手順

Google Cloud Consoleで現在の使用状況を確認できます：

1. **Google Cloud Consoleにアクセス**
   ```
   https://console.cloud.google.com
   ```

2. **プロジェクトを選択**
   - 画面上部のプロジェクト選択から該当プロジェクトを選択

3. **APIとサービス → 割り当て に移動**
   ```
   左メニュー → APIとサービス → 割り当て
   ```

4. **Blogger APIでフィルタリング**
   - 検索ボックスに「Blogger API」と入力
   - 現在の使用状況と上限が表示されます

5. **確認すべき項目**
   - `Queries per day`: 1日の総リクエスト数
   - `Queries per 100 seconds per user`: ユーザー単位のバースト制限
   - `Queries per second per user`: 1秒あたりのリクエスト数（QPS）

6. **リアルタイム監視（オプション）**
   ```
   左メニュー → APIとサービス → ダッシュボード → Blogger API
   ```
   - グラフで時間帯別のリクエスト数を確認できます

### 📊 使用量の目安

本ツールの使用状況（デフォルト設定）：

| 実行回数 | 投稿件数 | 所要時間 | Daily Limit消費 |
|---------|---------|---------|----------------|
| 1回 | 5件 | 約6秒 | 0.0005% |
| 10回 | 50件 | 約1分 | 0.005% |
| 100回 | 500件 | 約9分 | 0.05% |
| 1,000回 | 5,000件 | 約1.5時間 | 0.5% |

**注意**: 上記は最大値です。実際は重複スキップやエラーで投稿数は少なくなります。

### 🛡️ 安全なアップロード方法

1. **少量テスト**: 最初は`MAX_POSTS_PER_RUN = 1`で動作確認
2. **間隔調整**: エラーが出る場合は`DELAY_SECONDS = 2`に変更（より保守的に）
3. **分散実行**: 大量アップロードは複数回に分けて実行
4. **監視**: Google Cloud Consoleで使用量を定期確認

## リセット方法

何か問題が発生した場合、以下の手順でリセットできます：

### 認証情報をリセット

1. 以下のファイルを削除：
   ```bash
   rm token.pickle
   ```

2. Google Cloud Consoleで古いOAuth認証情報を削除（オプション）

3. アプリケーションを再起動すると、初回認証フローが再実行されます

### プロジェクト全体をリセット

1. Google Cloud Consoleでプロジェクトを削除
2. ステップ1から再度実行

## サポート

問題が発生した場合：

1. [トラブルシューティング](TROUBLESHOOTING.md)を確認
2. Google Cloud [ドキュメント](https://cloud.google.com/docs) を参照
3. [Blogger API リファレンス](https://developers.google.com/blogger)を確認

---

**最終更新**: 2026年1月28日
